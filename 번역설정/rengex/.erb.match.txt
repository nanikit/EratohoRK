# 에라 ERB 번역 텍스트 추출 정규식

# 행마다 매치 하나 처리를 전제
# 재귀를 사용할 수 없고 대신 모든 캡처를 처리

# 선행공백 스킵
\s*(
  # 블록 주석. 사실 아니긴 한데 그런 용도로 쓰는 듯.
  (?<textbc>\[SKIPSTART\][^\x00]*?\[SKIPEND\])

  # 띄어쓰기 소거대상
  # 표현식 문맥과 텍스트 문맥이 있다고 생각. 표현식 문맥이면 변수명이므로 번역문의 공백을 제거해야 한다.
  # 표현식에서 공백이 들어가면 아작나므로, 기본으로 표현식이라고 생각하고 텍스트를 거른다.

  # 텍스트 문맥이라고 간주하는 경우
  |(
    # 경우 1. 문자열 인자 명령
    (PRINT(?!BUTTON)\w*|DATA(FORM)?|THROW|CUSTOMDRAWLINE|DRAWLINEFORM|REUSELASTLINE|STRLEN(FORM)?U?|ESCAPE|INPUTS|DEBUGPRINT\w*)[ \t]+
    # 경우 2: 문자열 변수 대입문 우변. 사용자 변수는 노답.
    |(CDFLAGNAME[12]|WINDOW_TITLE|(|ABL|BASE|CALL|TCFLAG|CSTR|T?EQUIP|EXP?|FLAG|GLOBALS?|ITEM|MARK|MASTER|NICK|PALAM|SAVESTR|SOURCE|STAIN|STR|TALENT|TCVAR|TFLAG|TRAIN|TSTR)NAME|MONEYLABEL|GAMEBASE_(AUTHOR|INFO|TITLE|YEAR)|(C?|DRAWLINE|SAVE|T)STR|ARGS|GLOBALS|LOCALS|RESULTS|(SAVEDATA|LASTLOAD)_TEXT)
    (?<codeCC>.*?)=(?<![\u002B\-\u002A/%'].)(?!=)[ \t]*
    # 경우 3: 대입문 우변이 이스케이핑으로 시작
    |(?<codeCC>.*?)=(?<![\u002B\-\u002A/%'].)(?!=)[ \t]*(?=\\@|%)
  )

  # 위 조건을 통과했으므로 텍스트 문맥
  (?<textF>(
    # \@...\@
    \\@(?<=(^|[^\\])(\\\\)*..)
    (?<codeCC>(?>[^\\]|\\[^@]){1,999}?)
    \?(?<=[^\\](\\\\)*.)(
      (?<textCC>(?>[^\\]|\\[^@]){0,999}?)
      \#(?<=[^\\](\\\\)*.)(
        (?<textCC>(?>[^\\]|\\[^@]){0,999}?)
        \\@(?<=[^\\](\\\\)*..)
        |(?<textC>.*)
      )
      |(?<textC>.*)
    )
    # %...%
    |%(?<codeCC>(?>".*?"|[^"%\n]+|%|\n){0,30}?)%(?<=[^\\](\\\\)*.)
    # {...}
    |{(?<codeCC>(?>[^\n}]+|[}\n]){0,8}?)}(?<=[^\\](\\\\)*.)
    # 텍스트
    |(?<text>(?>[^\\%{;\r\n]|\\[^@])*?[\jp](?>[^\\%{;\r\n]|\\[^@])*)
    # 일본어 없으면 무시
    |(?>[^;"\\%{\r\n]+|\\[^@])+
    # \@ 짝 찾기 실패 시 무시
    |\\@
  )+)

  # 표현식 문맥
  |(?<codeF>(
    # 허용 가능한 토큰
    (?>(?!\w)[^";\r\n])+
    # "..."
    |"(
      # \@...\@
      \\@(?<=(^|[^\\])(\\\\)*..)
      (?<codeCC>(?>[^\\]|\\[^@]){1,999}?)
      \?(?<=[^\\](\\\\)*.)(
        (?<textCC>(?>[^\\]|\\[^@]){0,999}?)
        \#(?<=[^\\](\\\\)*.)(
          (?<textCC>(?>[^\\]|\\[^@])*?)
          \\@(?<=[^\\](\\\\)*..)
          |(?<textC>.*)
        )
        |(?<textC>.*)
      )
      # %...%
      |%(?<codeCC>(?>".*?"|[^"%\n]+|%|\n){0,30}?)%(?<=[^\\](\\\\)*.)
      # {...}
      |{(?<codeCC>(?>[^\n}]+|[}\n]){0,8}?)}(?<=[^\\](\\\\)*.)
      # 텍스트
      |(?<text>(?>[^"\\%{;\r\n]|\\[^@])*?[\jp](?>[^"\\%{;\r\n]|\\[^@])*)
      # 일본어 없으면 무시
      |(?>[^"\\%{\r\n]+|\\[^@])+
    )*?"
    # 일본어 명칭
    |(?<code>\w*?[\jp]\w*)
    # 일반 단어
    |(?>\w+|[ \t]+)
    # EVETRAIN.ERB:191
    |(?>"%|"{|"\\@|")
  )+)
  # 한 줄 주석을 위한 제로매치
  |
)

# 줄 끝엔 한 줄 주석이 나올 수 있다
((
  # 원본 문자열 주석은 무시
  ;OriginalString.*?
  |(?<textlc>;.*?)
)(\r?\n|$)
# 나올 수 없는 경우지만 혹시 모를 백트래킹 폭주를 막기 위해 스킵
|.*?(\n|$))